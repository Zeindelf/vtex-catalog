/*!!
 * VtexCatalog.js v1.0.0
 * https://github.com/zeindelf/vtex-catalog
 *
 * Copyright (c) 2017-2018 Zeindelf
 * Released under the MIT license
 *
 * Date: 2018-05-28T01:36:26.469Z
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(e.VTEX=e.VTEX||{},e.VTEX.VtexCatalog=r())}(this,function(){"use strict";var e="1.10.0",p={SEARCH_URL:"/api/catalog_system/pub/products/search/",ERRORS:{searchParamsNotDefined:"Search parameters is not defined.",searchParamsNotAnObject:"Search parameters is not a valid Object.",searchRangeNotArray:"'range' is not an Array",productIdNotDefined:"Product ID is not defined.",skuIdNotDefined:"Sku ID is not defined.",productIdArrayNotAnArray:"'productIdArray' is not an Array.",skuIdArrayNotAnArray:"'skuIdArray' is not an Array.",productIdArrayNotDefined:"'productIdArray' is not an defined.",skuIdArrayNotDefined:"'skuIdArray' is not an defined.",fqPropertyNotFound:"The property 'fq' was not found.",itemsIdNotDefined:"'itemsId' is not defined.",itemsIdNotAnArray:"'itemsId' is not an Array.",searchItemsNotDefined:"Search items is not defined. Use 'fq' or 'ft' to search.",shelfIdNotDefined:"'shelfId' is not defined.",shelfIdNotAString:"'shelfId' is not a String."},MESSAGES:{vtexUtils:'VtexUtils.js is required and must be an instance. Download it from https://www.npmjs.com/package/vtex-utils and use "new VtexCatalog(new VtexUtils())"',vtexUtilsVersion:e,vtexUtilsVersionMessage:"VtexUtils version must be higher than "+e+". Download last version on https://www.npmjs.com/package/vtex-utils"}},t=function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")},r=function(){function n(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,r,t){return r&&n(e.prototype,r),t&&n(e,t),e}}(),v=function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,r){var t=[],n=!0,a=!1,s=void 0;try{for(var o,i=e[Symbol.iterator]();!(n=(o=i.next()).done)&&(t.push(o.value),!r||t.length!==r);n=!0);}catch(e){a=!0,s=e}finally{try{!n&&i.return&&i.return()}finally{if(a)throw s}}return t}(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")},c=new(function(){function e(){t(this,e),this._maxParamsPerRequest=50,this._emptyFetchedParams=[],this._pendingParamsToFetch=[],this._fetchedParams=[],this._pendingFetchArray=[]}return r(e,[{key:"_getInstance",value:function(e,r){this._globalHelpers=e.globalHelpers,this._catalog=r}},{key:"_error",value:function(e){throw new Error(p.ERRORS[e])}},{key:"_setCache",value:function(e){var t=this,n=e.productId,r=e.items;this._catalog.productCache[n]=e,this._catalog.productCache[n]=e,r.forEach(function(e){var r=e.itemId;t._catalog.skusProductIds[r]=n})}},{key:"_search",value:function(a){var e,i=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},s=this,o=$.extend({},a),l=this._pendingFetchArray,u=[];for(var r in a)"map"!==r&&(o[r]=a[r].filter(function(e){return!~i._emptyFetchedParams.indexOf(e)&&(!~i._fetchedParams.indexOf(e)&&(!~i._pendingParamsToFetch.indexOf(e)&&(i._pendingParamsToFetch.push(e),!0)))}));var t=1;this._globalHelpers.isArray(a.fq)&&(t=o.fq.length);for(var f=Math.ceil(t/this._maxParamsPerRequest),c=function(e){var t=e*i._maxParamsPerRequest+"-"+((e+1)*i._maxParamsPerRequest-1),r=$.Deferred();$.ajax({url:p.SEARCH_URL,data:$.param(o,!0),beforeSend:function(e){for(var r in s._requestStartEvent(),n)({}).hasOwnProperty.call(n,r)&&e.setRequestHeader(r,n[r]);e.setRequestHeader("resources",t)},success:function(e){r.resolve(e)}}),l.push(r.promise())},d=0;d<f;d+=1)c(d);var h=$.Deferred();return(e=$).when.apply(e,function(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)}(l)).done(function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];for(var n in r.forEach(function(e,r){e.forEach(function(e){e=i._parseCamelize(e),i._setCache(e)}),l.splice(r,1)}),a)({}).hasOwnProperty.call(a,n)&&a[n].forEach(function(e){var r=e.split(":"),t=v(r,2),n=t[0],a=t[1],s=void 0;switch(i._fetchedParams.push(e),n){case"skuId":var o=i._catalog.skusProductIds[a];s=i._catalog.productCache[o];break;case"productId":s=i._catalog.productCache[a]}i._globalHelpers.isUndefined(s)?i._emptyFetchedParams.push(e):u.push(s)});h.resolve(u)}).fail(function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return h.reject(r)}),h.promise()}},{key:"_searchPage",value:function(e,t){var n=this,r=$.extend({},e),a=this._maxParamsPerRequest+"-"+(this._maxParamsPerRequest-1),s=$.Deferred();return $.ajax({url:"/buscapagina/",data:$.param(r,!0),beforeSend:function(e){for(var r in n._requestStartEvent(),t)({}).hasOwnProperty.call(t,r)&&e.setRequestHeader(r,t[r]);e.setRequestHeader("resources",a)}}).then(function(e){return s.resolve(e)}),s.promise()}},{key:"_parseCamelize",value:function(e){var t=this;if(this._camelizeItems&&((e=this._globalHelpers.camelize(e)).hasOwnProperty("allSpecifications")&&(e.allSpecifications=e.allSpecifications.map(function(e,r){return t._globalHelpers.camelize(e)})),this._camelizeProps))for(var r in e)({}).hasOwnProperty.call(e,r)&&this._globalHelpers.contains(r,this._camelizeProps)&&this._globalHelpers.isArray(e[r])&&(e[r]=e[r].map(function(e,r){return t._globalHelpers.camelize(e)}));return e}},{key:"_requestStartEvent",value:function(){var e=$.Event("requestStart.vtexCatalog");$(document).trigger(e)}},{key:"_requestEndEvent",value:function(e){var r=$.Event("request"+e+"End.vtexCatalog");$(document).trigger(r)}}]),e}()),n={_setInstance:function(e,r){c._getInstance(e,this)},setCamelize:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],r=1<arguments.length&&void 0!==arguments[1]&&arguments[1];c._camelizeItems=e,c._camelizeProps=r},setShelfClass:function(e){c._className=this.globalHelpers.isString(e)?e:""},searchProduct:function(e){if(this.globalHelpers.isUndefined(e))return c._error("productIdNotDefined");var n=$.Deferred();if(this.productCache[e])n.resolve(this.productCache[e]);else{var r={fq:["productId:"+e]};c._search(r).done(function(e){return n.resolve(!!e.length&&e[0])}).fail(function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return n.reject(r)})}return n.then(function(){return c._requestEndEvent("Product")}),n.promise()},searchSku:function(e){if(this.globalHelpers.isUndefined(e))return c._error("skuIdNotDefined");var n=$.Deferred();if(this.skusProductIds[e])n.resolve(this.productCache[this.skusProductIds[e]]);else{var r={fq:["skuId:"+e]};c._search(r).done(function(e){return n.resolve(!!e.length&&e[0])}).fail(function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return n.reject(r)})}return n.then(function(){return c._requestEndEvent("Sku")}),n.promise()},searchProductArray:function(e){var n=this;if(this.globalHelpers.isUndefined(e))return c._error("productIdArrayNotDefined");if(!this.globalHelpers.isArray(e))return c._error("productIdArrayNotAnArray");for(var a=$.Deferred(),s={},r={fq:[]},t=0,o=e.length;t<o;t+=1)this.globalHelpers.isUndefined(this.productCache[e[t]])?r.fq.push("productId:"+e[t]):s[e[t]]=this.productCache[e[t]];r.fq.length?c._search(r).done(function(e){for(var r=0,t=e.length;r<t;r+=1)s[e[r].productId]=e[r];a.resolve(!!n.globalHelpers.length(s)&&s)}).fail(function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return a.reject(r)}):a.resolve(s);return a.then(function(){return c._requestEndEvent("ProductArray")}),a.promise()},searchSkuArray:function(e){var n=this;if(this.globalHelpers.isUndefined(e))return c._error("skuIdArrayNotDefined");if(!this.globalHelpers.isArray(e))return c._error("skuIdArrayNotAnArray");for(var a=$.Deferred(),s={},r={fq:[]},t=0,o=e.length;t<o;t+=1)if(this.skusProductIds[e[t]]){var i=this.skusProductIds[e[t]];s[i]=this.productCache[i]}else r.fq.push("skuId:"+e[t]);r.fq.length?c._search(r).done(function(e){for(var r=0,t=e.length;r<t;r+=1)s[e[r].productId]=e[r];a.resolve(!!n.globalHelpers.length(s)&&s)}).fail(function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return a.reject(r)}):a.resolve(s);return a.then(function(){return c._requestEndEvent("SkuArray")}),a.promise()},searchDefault:function(e){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];if(this.globalHelpers.isUndefined(e))return c._error("searchParamsNotDefined");if(!this.globalHelpers.isObject(e))return c._error("searchParamsNotAnObject");if(!e.hasOwnProperty("fq")&&!e.hasOwnProperty("ft"))return c._error("searchItemsNotDefined");if(!this.globalHelpers.isArray(r))return c._error("searchRangeNotArray");var t={map:[]};if(e.hasOwnProperty("fq")){for(var n=0,a=e.fq.length;n<a;n+=1){var s=e.fq[n];if(s.match("C:"))for(var o=s.split("/"),i=0,l=o.length;i<l;i+=1)o[i].match(/\d.+/gi)&&t.map.push("c");s.match(/P\[.+[\d\w\s]?\]/g)&&t.map.push("priceFrom")}t.map=t.map.join(",")}var u={_from:r[0]<0?1:r[0]||1,_to:r[1]<0?50:r[1]||50};$.extend(e,t,u);var f=$.Deferred();if(49<u._to-u._from)throw new RangeError("Range must be a max value between 50 items");return $.ajax({url:p.SEARCH_URL,data:$.param(e,!0),beforeSend:function(e){c._requestStartEvent()}}).then(function(e,r,t){var n=e.map(function(e,r){return c._parseCamelize(e)});return $.Deferred().resolve(n,r,t).promise()}).done(function(){return f.resolve.apply(f,arguments)}).fail(function(e){return f.reject(e)}),f.then(function(){return c._requestEndEvent("SearchDefault")}),f.promise()},searchPage:function(t){var n=1<arguments.length&&void 0!==arguments[1]&&arguments[1],e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(this.globalHelpers.isUndefined(t))return c._error("searchParamsNotDefined");if(!this.globalHelpers.isPlainObject(t))return c._error("searchParamsNotAnObject");if(!t.hasOwnProperty("fq")&&!t.hasOwnProperty("ft"))return c._error("searchItemsNotDefined");if(this.globalHelpers.isUndefined(t.shelfId))return c._error("shelfIdNotDefined");if(!this.globalHelpers.isString(t.shelfId))return c._error("shelfIdNotAString");var a=$.Deferred(),r={},s={sl:t.shelfId,cc:t.columns||100,sm:t.sm||0,O:t.order||"",PageNumber:t.page||1};if(t.hasOwnProperty("fq")){r={fq:[],ps:t.quantity||this.globalHelpers.length(t.fq)};for(var o=0,i=t.fq.length;o<i;o+=1)r.fq.push("productId:"+t.fq[o])}t.hasOwnProperty("ft")&&(r={ft:t.ft,ps:t.quantity||10});var l=$.extend({},r,s);return c._searchPage(l,e).done(function(e){if(n){var r=$(e).find("li[layout="+t.shelfId+"]").removeClass("first last").removeAttr("layout").addClass(c._className);a.resolve(r)}else a.resolve(e)}).fail(function(e){return a.reject(e)}),a.then(function(){return c._requestEndEvent("SearchPage")}),a.promise()}};return function e(r){if(t(this,e),this.version="1.0.0",this.name="@VtexCatalog",void 0===r)throw new TypeError(p.MESSAGES.vtexUtils);if("@VtexUtils"!==r.name)throw new TypeError(p.MESSAGES.vtexUtils);if(r.version<p.MESSAGES.vtexUtilsVersion)throw new Error(p.MESSAGES.vtexUtilsVersionMessage);this.globalHelpers=r.globalHelpers,this.vtexHelpers=r.vtexHelpers,this.productCache={},this.skusProductIds={},this.globalHelpers.extend(e.prototype,n),this._setInstance(r)}});