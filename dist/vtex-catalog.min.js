/*!!
 * VtexCatalog.js v0.5.0
 * https://github.com/zeindelf/vtex-catalog
 *
 * Copyright (c) 2017-2018 Zeindelf
 * Released under the MIT license
 *
 * Date: 2018-02-18T19:30:35.961Z
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(e.VTEX=e.VTEX||{},e.VTEX.VtexCatalog=r())}(this,function(){"use strict";var e="0.9.5",r={SEARCH_URL:"/api/catalog_system/pub/products/search/",PRODUCT_CACHE_NAME:"__vtexCatalog.productCache__",SKU_CACHE_NAME:"__vtexCatalog.skuCache__",EXPIRE_TIME:14400,ERRORS:{searchParamsNotDefined:"Search parameters is not defined.",searchParamsNotAnObject:"Search parameters is not a valid Object.",searchRangeNotArray:"'range' is not an Array",productIdNotDefined:"Product ID is not defined.",skuIdNotDefined:"Sku ID is not defined.",productIdArrayNotAnArray:"'productIdArray' is not an Array.",skuIdArrayNotAnArray:"'skuIdArray' is not an Array.",productIdArrayNotDefined:"'productIdArray' is not an defined.",skuIdArrayNotDefined:"'skuIdArray' is not an defined.",fqPropertyNotFound:"The property 'fq' was not found.",itemsIdNotDefined:"'itemsId' is not defined.",itemsIdNotAnArray:"'itemsId' is not an Array.",searchItemsNotDefined:"Search items is not defined. Use 'fq' or 'ft' to search.",shelfIdNotDefined:"'shelfId' is not defined.",shelfIdNotAString:"'shelfId' is not a String."},MESSAGES:{vtexUtils:'VtexUtils.js is required and must be an instance. Download it from https://www.npmjs.com/package/vtex-utils and use "new VtexCatalog(new VtexUtils())"',vtexUtilsVersion:e,vtexUtilsVersionMessage:"VtexUtils version must be higher than 0.9.5. Download last version on https://www.npmjs.com/package/vtex-utils"}},t=function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")},n=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),s=function(){return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,r){var t=[],n=!0,s=!1,a=void 0;try{for(var o,i=e[Symbol.iterator]();!(n=(o=i.next()).done)&&(t.push(o.value),!r||t.length!==r);n=!0);}catch(e){s=!0,a=e}finally{try{!n&&i.return&&i.return()}finally{if(s)throw a}}return t}(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=new(function(){function e(){t(this,e),this._maxParamsPerRequest=50,this._emptyFetchedParams=[],this._pendingParamsToFetch=[],this._fetchedParams=[],this._pendingFetchArray=[]}return n(e,[{key:"_getInstance",value:function(e,r){this._globalHelpers=e.globalHelpers,this._catalog=r,this._storage=e.storage,this._session=this._storage.session}},{key:"_error",value:function(e){throw new Error(r.ERRORS[e])}},{key:"_setSessionCache",value:function(e){this._catalogCache=e,this._initStorage()}},{key:"_initStorage",value:function(){this._globalHelpers.isNull(this._session.get(r.PRODUCT_CACHE_NAME))&&this._session.set(r.PRODUCT_CACHE_NAME,{}),this._globalHelpers.isNull(this._session.get(r.SKU_CACHE_NAME))&&this._session.set(r.SKU_CACHE_NAME,{})}},{key:"_setProductCache",value:function(e){if(this._catalogCache){var t=this._session.get(r.PRODUCT_CACHE_NAME);for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n]);this._session.set(r.PRODUCT_CACHE_NAME,t,r.EXPIRE_TIME)}}},{key:"_setSkuCache",value:function(e){if(this._catalogCache){var t=this._session.get(r.SKU_CACHE_NAME);for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n]);this._session.set(r.SKU_CACHE_NAME,t,r.EXPIRE_TIME)}}},{key:"_getProductCache",value:function(){return this._catalogCache?this._session.get(r.PRODUCT_CACHE_NAME):this._catalog.productCache}},{key:"_getSkuCache",value:function(){return this._catalogCache?this._session.get(r.SKU_CACHE_NAME):this._catalog.skusProductIds}},{key:"_setCache",value:function(e){var r=this,t=e.productId,n=e.items;this._catalog.productCache[t]=e,this._catalogCache&&this._setProductCache(this._catalog.productCache),n.forEach(function(e){var n=e.itemId;r._catalog.skusProductIds[n]=t})}},{key:"_search",value:function(e){var t,n=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=$.extend({},e),i=this._pendingFetchArray,u=[];for(var c in e)"map"!==c&&(o[c]=e[c].filter(function(e){return!~n._emptyFetchedParams.indexOf(e)&&(!~n._fetchedParams.indexOf(e)&&(!~n._pendingParamsToFetch.indexOf(e)&&(n._pendingParamsToFetch.push(e),!0)))}));var d=1;this._globalHelpers.isArray(e.fq)&&(d=o.fq.length);for(var f=Math.ceil(d/this._maxParamsPerRequest),h=function(e){var t=e*n._maxParamsPerRequest+"-"+((e+1)*n._maxParamsPerRequest-1),s=$.Deferred();$.ajax({url:r.SEARCH_URL,data:$.param(o,!0),beforeSend:function(e){for(var r in a)({}).hasOwnProperty.call(a,r)&&e.setRequestHeader(r,a[r]);e.setRequestHeader("resources",t)},success:function(e){s.resolve(e)}}),i.push(s.promise())},l=0;l<f;l+=1)h(l);var _=$.Deferred();return(t=$).when.apply(t,function(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)}(i)).done(function(){for(var r=arguments.length,t=Array(r),a=0;a<r;a++)t[a]=arguments[a];for(var o in t.forEach(function(e,r){e.forEach(function(e){return n._setCache(e)}),i.splice(r,1)}),e)({}).hasOwnProperty.call(e,o)&&e[o].forEach(function(e){var r=e.split(":"),t=s(r,2),a=t[0],o=t[1],i=void 0;switch(n._fetchedParams.push(e),a){case"skuId":var c=n._catalog.skusProductIds[o];i=n._catalog.productCache[c];break;case"productId":i=n._catalog.productCache[o]}n._globalHelpers.isUndefined(i)?n._emptyFetchedParams.push(e):u.push(i)});u.length?(n._setSkuCache(n._catalog.skusProductIds),_.resolve(u)):_.reject()}),_.promise()}},{key:"_searchPage",value:function(e,r){var t=$.extend({},e),n=this._maxParamsPerRequest+"-"+(this._maxParamsPerRequest-1),s=$.Deferred();return $.ajax({url:"/buscapagina/",data:$.param(t,!0),beforeSend:function(e){for(var t in r)({}).hasOwnProperty.call(r,t)&&e.setRequestHeader(t,r[t]);e.setRequestHeader("resources",n)}}).then(function(e){s.resolve(e)}),s.promise()}},{key:"_requestEndEvent",value:function(e){var r=$.Event("request"+e+"End.vtexCatalog");setTimeout(function(){$(document).trigger(r)},0)}}]),e}()),o={_setInstance:function(e,r){a._getInstance(e,this),a._setSessionCache(r)},getProductCache:function(){return a._getProductCache()},getSkusProductId:function(){return a._getSkuCache()},searchProduct:function(e){if(this.globalHelpers.isUndefined(e))return a._error("productIdNotDefined");var r=$.Deferred(),t=a._getProductCache();if(t[e])r.resolve(t[e]);else{var n={fq:["productId:"+e]};a._search(n).done(function(e){return r.resolve(e[0])})}return r.then(function(){return a._requestEndEvent("Product")}),r.promise()},searchSku:function(e){if(this.globalHelpers.isUndefined(e))return a._error("skuIdNotDefined");var r=$.Deferred(),t=a._getProductCache(),n=a._getSkuCache();if(n[e])r.resolve(t[n[e]]);else{var s={fq:["skuId:"+e]};a._search(s).done(function(e){return r.resolve(e[0])})}return r.then(function(){return a._requestEndEvent("Sku")}),r.promise()},searchProductArray:function(e){if(this.globalHelpers.isUndefined(e))return a._error("productIdArrayNotDefined");if(!this.globalHelpers.isArray(e))return a._error("productIdArrayNotAnArray");for(var r=$.Deferred(),t={},n={fq:[]},s=a._getProductCache(),o=0,i=e.length;o<i;o+=1)this.globalHelpers.isUndefined(s[e[o]])?n.fq.push("productId:"+e[o]):t[e[o]]=s[e[o]];n.fq.length?a._search(n).done(function(e){for(var n=0,s=e.length;n<s;n+=1)t[e[n].productId]=e[n];r.resolve(t)}):r.resolve(t);return r.then(function(){return a._requestEndEvent("ProductArray")}),r.promise()},searchSkuArray:function(e){if(this.globalHelpers.isUndefined(e))return a._error("skuIdArrayNotDefined");if(!this.globalHelpers.isArray(e))return a._error("skuIdArrayNotAnArray");for(var r=$.Deferred(),t={},n={fq:[]},s=a._getProductCache(),o=a._getSkuCache(),i=0,u=e.length;i<u;i+=1)if(o[e[i]]){var c=o[e[i]];t[c]=s[c]}else n.fq.push("skuId:"+e[i]);n.fq.length?a._search(n).done(function(e){for(var n=0,s=e.length;n<s;n+=1)t[e[n].productId]=e[n];r.resolve(t)}):r.resolve(t);return r.then(function(){return a._requestEndEvent("SkuArray")}),r.promise()},searchDefault:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(this.globalHelpers.isUndefined(e))return a._error("searchParamsNotDefined");if(!this.globalHelpers.isObject(e))return a._error("searchParamsNotAnObject");if(this.globalHelpers.isUndefined(e.fq))return a._error("fqPropertyNotFound");if(!this.globalHelpers.isArray(t))return a._error("searchRangeNotArray");for(var n={map:[]},s=0,o=e.fq.length;s<o;s+=1){var i=e.fq[s];if(i.match("C:"))for(var u=i.split("/"),c=0,d=u.length;c<d;c+=1)u[c].match(/\d.+/gi)&&n.map.push("c");i.match(/P\[.+[\d\w\s]?\]/g)&&n.map.push("priceFrom")}n.map=n.map.join(",");var f={_from:(t[0]<1?1:t[0])||1,_to:(t[1]>50?50:t[1])||50};$.extend(e,n,f);var h=$.Deferred();return $.ajax({url:r.SEARCH_URL,data:$.param(e,!0),beforeSend:function(e){e.setRequestHeader("resources","0-49")}}).done(function(){return h.resolve.apply(h,arguments)}).fail(function(e){return h.reject(e)}),h.then(function(){return a._requestEndEvent("SearchDefault")}),h.promise()},searchPage:function(e){var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(this.globalHelpers.isUndefined(e))return a._error("searchParamsNotDefined");if(!this.globalHelpers.isPlainObject(e))return a._error("searchParamsNotAnObject");if(!e.hasOwnProperty("fq")&&!e.hasOwnProperty("ft"))return a._error("searchItemsNotDefined");if(this.globalHelpers.isUndefined(e.shelfId))return a._error("shelfIdNotDefined");if(!this.globalHelpers.isString(e.shelfId))return a._error("shelfIdNotAString");var n=$.Deferred(),s={},o={sl:e.shelfId,cc:e.columns||100,sm:e.sm||0,O:e.order||"",PageNumber:1};if(e.hasOwnProperty("fq")){s={fq:[],ps:e.quantity||this.globalHelpers.length(e.fq)};for(var i=0,u=e.fq.length;i<u;i+=1)s.fq.push("productId:"+e.fq[i])}e.hasOwnProperty("ft")&&(s={ft:e.ft,ps:e.quantity||10});var c=$.extend({},s,o);return a._searchPage(c,t).done(function(t){if(r){var s=$(t).find("li[layout="+e.shelfId+"]");n.resolve(s)}else n.resolve(t)}).fail(function(e){return n.reject(e)}),n.then(function(){return a._requestEndEvent("SearchPage")}),n.promise()}};return function e(n){var s=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t(this,e),this.version="0.5.0",this.name="@VtexCatalog",void 0===n)throw new TypeError(r.MESSAGES.vtexUtils);if("@VtexUtils"!==n.name)throw new TypeError(r.MESSAGES.vtexUtils);if(n.version<r.MESSAGES.vtexUtilsVersion)throw new Error(r.MESSAGES.vtexUtilsVersionMessage);this.globalHelpers=n.globalHelpers,this.vtexHelpers=n.vtexHelpers,this.storage=n.storage,this.productCache={},this.skusProductIds={},this.globalHelpers.extend(e.prototype,o),this._setInstance(n,s)}});