/*!!
 * VtexCatalog.js v0.9.0
 * https://github.com/zeindelf/vtex-catalog
 *
 * Copyright (c) 2017-2018 Zeindelf
 * Released under the MIT license
 *
 * Date: 2018-05-14T03:20:49.323Z
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(e.VTEX=e.VTEX||{},e.VTEX.VtexCatalog=r())}(this,function(){"use strict";var e="1.1.0",d={SEARCH_URL:"/api/catalog_system/pub/products/search/",PRODUCT_CACHE_NAME:"_vc_product",SKU_CACHE_NAME:"_vc_sku",EXPIRE_TIME:14400,EVENT_TIME:150,ERRORS:{searchParamsNotDefined:"Search parameters is not defined.",searchParamsNotAnObject:"Search parameters is not a valid Object.",searchRangeNotArray:"'range' is not an Array",productIdNotDefined:"Product ID is not defined.",skuIdNotDefined:"Sku ID is not defined.",productIdArrayNotAnArray:"'productIdArray' is not an Array.",skuIdArrayNotAnArray:"'skuIdArray' is not an Array.",productIdArrayNotDefined:"'productIdArray' is not an defined.",skuIdArrayNotDefined:"'skuIdArray' is not an defined.",fqPropertyNotFound:"The property 'fq' was not found.",itemsIdNotDefined:"'itemsId' is not defined.",itemsIdNotAnArray:"'itemsId' is not an Array.",searchItemsNotDefined:"Search items is not defined. Use 'fq' or 'ft' to search.",shelfIdNotDefined:"'shelfId' is not defined.",shelfIdNotAString:"'shelfId' is not a String."},MESSAGES:{vtexUtils:'VtexUtils.js is required and must be an instance. Download it from https://www.npmjs.com/package/vtex-utils and use "new VtexCatalog(new VtexUtils())"',vtexUtilsVersion:e,vtexUtilsVersionMessage:"VtexUtils version must be higher than 1.1.0. Download last version on https://www.npmjs.com/package/vtex-utils"}},s=function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")},r=function(){function s(e,r){for(var t=0;t<r.length;t++){var s=r[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(e,r,t){return r&&s(e.prototype,r),t&&s(e,t),e}}(),_=function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,r){var t=[],s=!0,a=!1,n=void 0;try{for(var o,i=e[Symbol.iterator]();!(s=(o=i.next()).done)&&(t.push(o.value),!r||t.length!==r);s=!0);}catch(e){a=!0,n=e}finally{try{!s&&i.return&&i.return()}finally{if(a)throw n}}return t}(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")},f=new(function(){function e(){s(this,e),this._maxParamsPerRequest=50,this._emptyFetchedParams=[],this._pendingParamsToFetch=[],this._fetchedParams=[],this._pendingFetchArray=[]}return r(e,[{key:"_getInstance",value:function(e,r){this._globalHelpers=e.globalHelpers,this._catalog=r,this._storage=e.storage,this._session=this._storage.session}},{key:"_error",value:function(e){throw new Error(d.ERRORS[e])}},{key:"_setSessionCache",value:function(e){this._catalogCache=e,this._initStorage()}},{key:"_initStorage",value:function(){this._globalHelpers.isNull(this._session.get(d.PRODUCT_CACHE_NAME))&&this._session.set(d.PRODUCT_CACHE_NAME,{}),this._globalHelpers.isNull(this._session.get(d.SKU_CACHE_NAME))&&this._session.set(d.SKU_CACHE_NAME,{})}},{key:"_setProductCache",value:function(e){if(this._catalogCache){var r=this._session.get(d.PRODUCT_CACHE_NAME);for(var t in e)r.hasOwnProperty(t)||(r[t]=e[t]);this._session.set(d.PRODUCT_CACHE_NAME,r,d.EXPIRE_TIME)}}},{key:"_setSkuCache",value:function(e){if(this._catalogCache){var r=this._session.get(d.SKU_CACHE_NAME);for(var t in e)r.hasOwnProperty(t)||(r[t]=e[t]);this._session.set(d.SKU_CACHE_NAME,r,d.EXPIRE_TIME)}}},{key:"_getProductCache",value:function(){return this._catalogCache?this._session.get(d.PRODUCT_CACHE_NAME):this._catalog.productCache}},{key:"_getSkuCache",value:function(){return this._catalogCache?this._session.get(d.SKU_CACHE_NAME):this._catalog.skusProductIds}},{key:"_setCache",value:function(e){var t=this,s=e.productId,r=e.items;this._catalog.productCache[s]=e,this._catalogCache&&this._setProductCache(this._catalog.productCache),r.forEach(function(e){var r=e.itemId;t._catalog.skusProductIds[r]=s})}},{key:"_search",value:function(a){var e,i=this,s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=$.extend({},a),o=this._pendingFetchArray,u=[];for(var r in a)"map"!==r&&(n[r]=a[r].filter(function(e){return!~i._emptyFetchedParams.indexOf(e)&&(!~i._fetchedParams.indexOf(e)&&(!~i._pendingParamsToFetch.indexOf(e)&&(i._pendingParamsToFetch.push(e),!0)))}));var t=1;this._globalHelpers.isArray(a.fq)&&(t=n.fq.length);for(var c=Math.ceil(t/this._maxParamsPerRequest),l=function(e){var t=e*i._maxParamsPerRequest+"-"+((e+1)*i._maxParamsPerRequest-1),r=$.Deferred();$.ajax({url:d.SEARCH_URL,data:$.param(n,!0),beforeSend:function(e){for(var r in s)({}).hasOwnProperty.call(s,r)&&e.setRequestHeader(r,s[r]);e.setRequestHeader("resources",t)},success:function(e){r.resolve(e)}}),o.push(r.promise())},f=0;f<c;f+=1)l(f);var h=$.Deferred();return(e=$).when.apply(e,function(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)}(o)).done(function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];for(var s in r.forEach(function(e,r){e.forEach(function(e){e=i._parseCamelize(e),i._setCache(e)}),o.splice(r,1)}),a)({}).hasOwnProperty.call(a,s)&&a[s].forEach(function(e){var r=e.split(":"),t=_(r,2),s=t[0],a=t[1],n=void 0;switch(i._fetchedParams.push(e),s){case"skuId":var o=i._catalog.skusProductIds[a];n=i._catalog.productCache[o];break;case"productId":n=i._catalog.productCache[a]}i._globalHelpers.isUndefined(n)?i._emptyFetchedParams.push(e):u.push(n)});u.length&&i._setSkuCache(i._catalog.skusProductIds),h.resolve(u)}),h.promise()}},{key:"_searchPage",value:function(e,t){var r=$.extend({},e),s=this._maxParamsPerRequest+"-"+(this._maxParamsPerRequest-1),a=$.Deferred();return $.ajax({url:"/buscapagina/",data:$.param(r,!0),beforeSend:function(e){for(var r in t)({}).hasOwnProperty.call(t,r)&&e.setRequestHeader(r,t[r]);e.setRequestHeader("resources",s)}}).then(function(e){a.resolve(e)}),a.promise()}},{key:"_parseCamelize",value:function(e){var t=this;if(this._camelizeItems&&((e=this._globalHelpers.camelize(e)).hasOwnProperty("allSpecifications")&&(e.allSpecifications=e.allSpecifications.map(function(e,r){return t._globalHelpers.camelize(e)})),this._camelizeProps))for(var r in e)({}).hasOwnProperty.call(e,r)&&this._globalHelpers.contains(r,this._camelizeProps)&&this._globalHelpers.isArray(e[r])&&(e[r]=e[r].map(function(e,r){return t._globalHelpers.camelize(e)}));return e}},{key:"_requestEndEvent",value:function(e){var r=$.Event("request"+e+"End.vtexCatalog");setTimeout(function(){$(document).trigger(r)},this._eventTime)}}]),e}()),a={_setInstance:function(e,r){f._getInstance(e,this),f._setSessionCache(r)},setEventTime:function(e){f._eventTime=this.globalHelpers.isNumber(e)?e:d.EVENT_TIME},setCamelize:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],r=1<arguments.length&&void 0!==arguments[1]&&arguments[1];f._camelizeItems=e,f._camelizeProps=r},setShelfClass:function(e){f._className=this.globalHelpers.isString(e)?e:""},getProductCache:function(){return f._getProductCache()},getSkusProductId:function(){return f._getSkuCache()},searchProduct:function(e){if(this.globalHelpers.isUndefined(e))return f._error("productIdNotDefined");var r=$.Deferred(),t=f._getProductCache();if(t[e])r.resolve(t[e]);else{var s={fq:["productId:"+e]};f._search(s).done(function(e){return r.resolve(e[0])})}return r.then(function(){return f._requestEndEvent("Product")}),r.promise()},searchSku:function(e){if(this.globalHelpers.isUndefined(e))return f._error("skuIdNotDefined");var r=$.Deferred(),t=f._getProductCache(),s=f._getSkuCache();if(s[e])r.resolve(t[s[e]]);else{var a={fq:["skuId:"+e]};f._search(a).done(function(e){return r.resolve(e[0])})}return r.then(function(){return f._requestEndEvent("Sku")}),r.promise()},searchProductArray:function(e){if(this.globalHelpers.isUndefined(e))return f._error("productIdArrayNotDefined");if(!this.globalHelpers.isArray(e))return f._error("productIdArrayNotAnArray");for(var s=$.Deferred(),a={},r={fq:[]},t=f._getProductCache(),n=0,o=e.length;n<o;n+=1)this.globalHelpers.isUndefined(t[e[n]])?r.fq.push("productId:"+e[n]):a[e[n]]=t[e[n]];r.fq.length?f._search(r).done(function(e){for(var r=0,t=e.length;r<t;r+=1)a[e[r].productId]=e[r];s.resolve(a)}):s.resolve(a);return s.then(function(){return f._requestEndEvent("ProductArray")}),s.promise()},searchSkuArray:function(e){if(this.globalHelpers.isUndefined(e))return f._error("skuIdArrayNotDefined");if(!this.globalHelpers.isArray(e))return f._error("skuIdArrayNotAnArray");for(var s=$.Deferred(),a={},r={fq:[]},t=f._getProductCache(),n=f._getSkuCache(),o=0,i=e.length;o<i;o+=1)if(n[e[o]]){var u=n[e[o]];a[u]=t[u]}else r.fq.push("skuId:"+e[o]);r.fq.length?f._search(r).done(function(e){for(var r=0,t=e.length;r<t;r+=1)a[e[r].productId]=e[r];s.resolve(a)}):s.resolve(a);return s.then(function(){return f._requestEndEvent("SkuArray")}),s.promise()},searchDefault:function(e){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];if(this.globalHelpers.isUndefined(e))return f._error("searchParamsNotDefined");if(!this.globalHelpers.isObject(e))return f._error("searchParamsNotAnObject");if(!e.hasOwnProperty("fq")&&!e.hasOwnProperty("ft"))return f._error("searchItemsNotDefined");if(!this.globalHelpers.isArray(r))return f._error("searchRangeNotArray");var t={map:[]};if(e.hasOwnProperty("fq")){for(var s=0,a=e.fq.length;s<a;s+=1){var n=e.fq[s];if(n.match("C:"))for(var o=n.split("/"),i=0,u=o.length;i<u;i+=1)o[i].match(/\d.+/gi)&&t.map.push("c");n.match(/P\[.+[\d\w\s]?\]/g)&&t.map.push("priceFrom")}t.map=t.map.join(",")}var c={_from:r[0]<0?1:r[0]||1,_to:r[1]<0?50:r[1]||50};$.extend(e,t,c);var l=$.Deferred();return 49<c._to-c._from&&l.reject("Range must be a max value between 50 items"),$.ajax({url:d.SEARCH_URL,data:$.param(e,!0)}).then(function(e,r,t){var s=e.map(function(e,r){return f._parseCamelize(e)});return $.Deferred().resolve(s,r,t).promise()}).done(function(){return l.resolve.apply(l,arguments)}).fail(function(e){return l.reject(e)}),l.then(function(){return f._requestEndEvent("SearchDefault")}),l.promise()},searchPage:function(t){var s=1<arguments.length&&void 0!==arguments[1]&&arguments[1],e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(this.globalHelpers.isUndefined(t))return f._error("searchParamsNotDefined");if(!this.globalHelpers.isPlainObject(t))return f._error("searchParamsNotAnObject");if(!t.hasOwnProperty("fq")&&!t.hasOwnProperty("ft"))return f._error("searchItemsNotDefined");if(this.globalHelpers.isUndefined(t.shelfId))return f._error("shelfIdNotDefined");if(!this.globalHelpers.isString(t.shelfId))return f._error("shelfIdNotAString");var a=$.Deferred(),r={},n={sl:t.shelfId,cc:t.columns||100,sm:t.sm||0,O:t.order||"",PageNumber:t.page||1};if(t.hasOwnProperty("fq")){r={fq:[],ps:t.quantity||this.globalHelpers.length(t.fq)};for(var o=0,i=t.fq.length;o<i;o+=1)r.fq.push("productId:"+t.fq[o])}t.hasOwnProperty("ft")&&(r={ft:t.ft,ps:t.quantity||10});var u=$.extend({},r,n);return f._searchPage(u,e).done(function(e){if(s){var r=$(e).find("li[layout="+t.shelfId+"]").removeAttr("layout").addClass(f._className);a.resolve(r)}else a.resolve(e)}).fail(function(e){return a.reject(e)}),a.then(function(){return f._requestEndEvent("SearchPage")}),a.promise()}};return function e(r){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(s(this,e),this.version="0.9.0",this.name="@VtexCatalog",void 0===r)throw new TypeError(d.MESSAGES.vtexUtils);if("@VtexUtils"!==r.name)throw new TypeError(d.MESSAGES.vtexUtils);if(r.version<d.MESSAGES.vtexUtilsVersion)throw new Error(d.MESSAGES.vtexUtilsVersionMessage);this.globalHelpers=r.globalHelpers,this.vtexHelpers=r.vtexHelpers,this.storage=r.storage,this.productCache={},this.skusProductIds={},this.globalHelpers.extend(e.prototype,a),this._setInstance(r,t)}});